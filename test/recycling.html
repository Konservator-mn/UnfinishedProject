<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        var startTime = Date.now();
    </script>
    <meta charset="UTF-8">
    <style>
        body{
            margin: 0px;
        }
    </style>
    <title>Canvas</title>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
    var canvas = document.getElementById('canvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight-4;
    var ctx = canvas.getContext('2d');
    Recycling(canvas.height/3, {x:canvas.width/2, y: canvas.height/3}, 1000);

    function Recycling (height, topPoint, time) {
        var step = 1/time;
        var pastPart = 0;

        var sqrt3 = Math.sqrt(3);
        var hDivSqrt3 = height/sqrt3;
        var pow2 = function (val) {
            return Math.pow(val, 2);
        };


        var distBetweenPnts = function (A, B) {
            var dist = Math.sqrt(pow2(A.x-B.x)+pow2(A.y-B.y));
            console.log(dist);
            return dist;
        };

        var arrowParams = {
            head:{
                height: height/4,
                width: height/2
            },
            body: {
                width: height/2,
                height: height,
                bottomShift:{
                    x: height/2,
                    y: sqrt3*height/2
                }
            }
        };
        var bodyPart = arrowParams.body.width/(arrowParams.head.width*4);
        var pathPoints = {
            top:{
                x: topPoint.x,
                y: topPoint.y
            },
            right:{
                x: topPoint.x + hDivSqrt3,
                y: topPoint.y + height
            },
            left: {
                x: topPoint.x - hDivSqrt3,
                y: topPoint.y + height
            }
        };

        var turnPoints = {
            top:{
                right:[
                    {
                        x:topPoint.x - arrowParams.body.width/4,
                        y:topPoint.y - sqrt3*arrowParams.body.width/4
                    },
                    {
                        x:topPoint.x - arrowParams.body.width/2,
                        y:topPoint.y - sqrt3*arrowParams.body.width/2
                    }
                ],
                left:[
                    {
                        x:topPoint.x + arrowParams.body.width/4,
                        y:topPoint.y - sqrt3*arrowParams.body.width/4
                    },
                    {
                        x:topPoint.x + arrowParams.body.width/2,
                        y:topPoint.y - sqrt3*arrowParams.body.width/2
                    }
                ]
            },
            left:{
                right:[
                    {
                        x: topPoint.x - hDivSqrt3 - arrowParams.body.width/2,
                        y: topPoint.y + height
                    },
                    {
                        x: topPoint.x - hDivSqrt3 - arrowParams.body.width,
                        y: topPoint.y + height
                    }
                ],
                top:[
                    {
                        x: topPoint.x - hDivSqrt3 - arrowParams.body.width/4,
                        y: topPoint.y + height + sqrt3*arrowParams.body.width/4
                    },
                    {
                        x: topPoint.x - hDivSqrt3 - arrowParams.body.width/2,
                        y: topPoint.y + height + sqrt3*arrowParams.body.width/2
                    }
                ]
            },
            right:{
                left:[
                    {
                        x: topPoint.x + hDivSqrt3 + arrowParams.body.width/2,
                        y: topPoint.y + height
                    },
                    {
                        x: topPoint.x + hDivSqrt3 + arrowParams.body.width,
                        y: topPoint.y + height
                    }
                ],
                top:[
                    {
                        x: topPoint.x + hDivSqrt3 + arrowParams.body.width/4,
                        y: topPoint.y + height + sqrt3*arrowParams.body.width/4
                    },
                    {
                        x: topPoint.x + hDivSqrt3 + arrowParams.body.width/2,
                        y: topPoint.y + height + sqrt3*arrowParams.body.width/2
                    }
                ]
            }
        };

        var ways = new Ways();

        function Ways() {
            var straightLength = distBetweenPnts(turnPoints.top.right[0], turnPoints.left.right[0]);
            var turnLength = arrowParams.body.width/2;
            var totalLength = arrowParams.body.width/2 + straightLength;
            this.length = {
                turn: turnLength,
                straight: straightLength,
                total: totalLength
            };
            this.straightRatio = straightLength/totalLength;
        }

        function ArrowsPoints(wayPartPassed) {
            this.turn = {};

            Object.defineProperty(this.turn, 'head', {
                get: function () {
                    return wayPartPassed>ways.straightRatio;
                }
            });
            var koef = (this.turn.head)?((wayPartPassed-ways.straightRatio)/(1-ways.straightRatio)):(wayPartPassed/ways.straightRatio);


            this.left = {
                top: (this.turn.head)?
                    coordPointBetween(turnPoints.top.right[0], turnPoints.top.left[0]):
                    coordPointBetween(turnPoints.left.right[0], turnPoints.top.right[0])
            };
            this.left.angles = (this.turn.head)?
                [{
                    x: this.left.top.x - arrowParams.head.height,
                    y: this.left.top.y - arrowParams.head.width
                },{
                    x: this.left.top.x - arrowParams.head.height,
                    y: this.left.top.y + arrowParams.head.width
                }
            ]:[
                {
                    x: this.left.top.x + (sqrt3*arrowParams.head.width - arrowParams.head.height)/2,
                    y: this.left.top.y + (sqrt3*arrowParams.head.height + arrowParams.head.width)/2
                },
                {
                    x: this.left.top.x - (arrowParams.head.height + sqrt3*arrowParams.head.width)/2,
                    y: this.left.top.y + 2*arrowParams.head.height/(arrowParams.head.width - sqrt3*arrowParams.head.height)
                }
            ];
            this.left.body = {
                top: coordBodyTopPoints(this.left.angles)
            };
            this.left.body.bottom = [
                {
                    x: this.left.body.top[0].x - arrowParams.body.bottomShift.x,
                    y: this.left.body.top[0].y + arrowParams.body.bottomShift.y
                },
                {
                    x: this.left.body.top[1].x - arrowParams.body.bottomShift.x,
                    y: this.left.body.top[1].y + arrowParams.body.bottomShift.y
                }
            ];



            this.right = {
                top: (this.turn.head)?
                    coordPointBetween(turnPoints.right.left[0], turnPoints.right.top[0]):
                    coordPointBetween(turnPoints.top.left[0], turnPoints.right.left[0])
            };
            this.right.angles = (this.turn.head)?[
                {
                    x: this.right.top.x - (sqrt3*arrowParams.head.width - arrowParams.head.height)/2,
                    y: this.right.top.y - (sqrt3*arrowParams.head.height + arrowParams.head.width)/2
                },
                {
                    x: this.right.top.x + (arrowParams.head.height + sqrt3*arrowParams.head.width)/2,
                    y: this.right.top.y - 2*arrowParams.head.height/(arrowParams.head.width - sqrt3*arrowParams.head.height)
                }
            ]:[
                {
                    x: this.right.top.x + (sqrt3*arrowParams.head.width - arrowParams.head.height)/2,
                    y: this.right.top.y - (sqrt3*arrowParams.head.height + arrowParams.head.width)/2
                },
                {
                    x: this.right.top.x - (arrowParams.head.height + sqrt3*arrowParams.head.width)/2,
                    y: this.right.top.y - 2*arrowParams.head.height/(arrowParams.head.width - sqrt3*arrowParams.head.height)
                }
            ];
            this.right.body = {
                top: coordBodyTopPoints(this.right.angles)
            };
            this.right.body.bottom = [
                {
                    x: this.right.body.top[0].x - arrowParams.body.bottomShift.x,
                    y: this.right.body.top[0].y - arrowParams.body.bottomShift.y
                },
                {
                    x: this.right.body.top[1].x - arrowParams.body.bottomShift.x,
                    y: this.right.body.top[1].y - arrowParams.body.bottomShift.y
                }
            ];

            this.bottom = {
                top: (this.turn.head)?
                    coordPointBetween(turnPoints.left.top[0], turnPoints.left.right[0]):
                    coordPointBetween(turnPoints.right.top[0], turnPoints.left.top[0])
            };
            this.bottom.angles = (this.turn.head)?
            [
                {
                    x: this.bottom.top.x + (arrowParams.head.height + sqrt3*arrowParams.head.width)/2,
                    y: this.bottom.top.y - 2*arrowParams.head.height/(arrowParams.head.width - sqrt3*arrowParams.head.height)
                },
                {
                    x: this.bottom.top.x - (sqrt3*arrowParams.head.width - arrowParams.head.height)/2,
                    y: this.bottom.top.y + (sqrt3*arrowParams.head.height + arrowParams.head.width)/2
                }
            ]:[
                {
                    x: this.bottom.top.x + arrowParams.head.height,
                    y: this.bottom.top.y - arrowParams.head.width
                },
                {
                    x: this.bottom.top.x + arrowParams.head.height,
                    y: this.bottom.top.y + arrowParams.head.width
                }
            ];
            this.bottom.body = {
                top: coordBodyTopPoints(this.bottom.angles)
            };
            this.bottom.body.bottom =
                [
                    {
                        x: this.bottom.body.top[0].x+arrowParams.body.height,
                        y: this.bottom.body.top[0].y
                    },
                    {
                        x: this.bottom.body.top[1].x+arrowParams.body.height,
                        y: this.bottom.body.top[1].y
                    }
                ];



            function coordBodyTopPoints(angles) {
                var middle = {
                    x: (angles[0].x + angles[1].x)/2,
                    y: (angles[0].y + angles[1].y)/2
                };
                var xShift = (angles[0].x - angles[1].x)*bodyPart;
                var yShift = (angles[0].y - angles[1].y)*bodyPart;

                return [
                    {
                        x: middle.x - xShift,
                        y: middle.y - yShift
                    },
                    {
                        x: middle.x + xShift,
                        y: middle.y + yShift
                    }
                ];
            }
            function coordPointBetween(fromXy, toXy) {
                var oneDim = function (fromA, toB) {
                    if (fromA>toB)
                        return (fromA -(fromA-toB)*koef);
                    else if (fromA === toB){
                        return fromA;
                    } else {
                        return (fromA +(toB-fromA)*koef);
                    }
                };
                return {
                    x: oneDim(fromXy.x, toXy.x),
                    y: oneDim(fromXy.y, toXy.y)
                };

            }
        }

        //###############################Dev Functions#######################################



        var counter=0;

        var testInterval = setInterval(function () {


            if (pastPart<1 /*&& counter++ <3*/){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawAllPonts();
                drawPathLines();
                var arrowsPoints = new ArrowsPoints(pastPart);
                pastPart+=step;
                ctx.setLineDash([0, 0]);

                drawPoint(arrowsPoints.left.top);
                drawPoint(arrowsPoints.left.angles[0]);
                drawPoint(arrowsPoints.left.angles[1]);
                drawTriangle(arrowsPoints.left.top, arrowsPoints.left.angles[0], arrowsPoints.left.angles[1]);
                drawPoint(arrowsPoints.left.body.top[0]);
                drawPoint(arrowsPoints.left.body.top[1]);
                drawPoint(arrowsPoints.left.body.bottom[0]);
                drawPoint(arrowsPoints.left.body.bottom[1]);
                drawArrowBody(arrowsPoints.left.body.top, arrowsPoints.left.body.bottom);

                drawPoint(arrowsPoints.right.top);
                drawPoint(arrowsPoints.right.angles[0]);
                drawPoint(arrowsPoints.right.angles[1]);
                drawTriangle(arrowsPoints.right.top, arrowsPoints.right.angles[0], arrowsPoints.right.angles[1]);
                drawPoint(arrowsPoints.right.body.top[0]);
                drawPoint(arrowsPoints.right.body.top[1]);
                drawPoint(arrowsPoints.right.body.bottom[0]);
                drawPoint(arrowsPoints.right.body.bottom[1]);
                drawArrowBody(arrowsPoints.right.body.top, arrowsPoints.right.body.bottom);

                drawPoint(arrowsPoints.bottom.top);
                drawPoint(arrowsPoints.bottom.angles[0]);
                drawPoint(arrowsPoints.bottom.angles[1]);
                drawTriangle(arrowsPoints.bottom.top, arrowsPoints.bottom.angles[0], arrowsPoints.bottom.angles[1]);
                drawPoint(arrowsPoints.bottom.body.top[0]);
                drawPoint(arrowsPoints.bottom.body.top[1]);
                drawPoint(arrowsPoints.bottom.body.bottom[0]);
                drawPoint(arrowsPoints.bottom.body.bottom[1]);
                drawArrowBody(arrowsPoints.bottom.body.top, arrowsPoints.bottom.body.bottom);
            } else {
                clearInterval(testInterval);
            }
            return;
        }, 1);


        function drawArrowBody(top, bottom) {
            ctx.beginPath();
            ctx.moveTo(top[0].x, top[0].y);
            ctx.lineTo(bottom[0].x, bottom[0].y);
            ctx.lineTo(bottom[1].x, bottom[1].y);
            ctx.lineTo(top[1].x, top[1].y);
            ctx.stroke();
            return;
        }
        function drawPathLines() {
            ctx.setLineDash([8, 3]);
            drawLine(pathPoints.top, pathPoints.right);
            drawLine(pathPoints.right, pathPoints.left);
            drawLine(pathPoints.left, pathPoints.top);

            drawLine(turnPoints.top.right[0], turnPoints.top.left[0]);
            drawLine(turnPoints.top.right[1], turnPoints.top.left[1]);
            drawLine(turnPoints.top.left[0], turnPoints.right.left[0]);
            drawLine(turnPoints.top.left[1], turnPoints.right.left[1]);
            drawLine(turnPoints.right.left[0], turnPoints.right.top[0]);
            drawLine(turnPoints.right.left[1], turnPoints.right.top[1]);
            drawLine(turnPoints.right.top[0], turnPoints.left.top[0]);
            drawLine(turnPoints.right.top[1], turnPoints.left.top[1]);
            drawLine(turnPoints.left.top[0], turnPoints.left.right[0]);
            drawLine(turnPoints.left.top[1], turnPoints.left.right[1]);
            drawLine(turnPoints.left.right[0], turnPoints.top.right[0]);
            drawLine(turnPoints.left.right[1], turnPoints.top.right[1]);

            drawLine(pathPoints.top, turnPoints.top.right[1]);
            drawLine(pathPoints.top, turnPoints.top.left[1]);
            drawLine(pathPoints.right, turnPoints.right.left[1]);
            drawLine(pathPoints.right, turnPoints.right.top[1]);
            drawLine(pathPoints.left, turnPoints.left.top[1]);
            drawLine(pathPoints.left, turnPoints.left.right[1]);

            return;
        }
        function drawAllPonts() {
            for (angle in turnPoints)
                for (side in turnPoints[angle])
                    turnPoints[angle][side].forEach(function (value) {
                        drawPoint(value);
                    });
            for (angle in pathPoints)
                drawPoint(pathPoints[angle]);

            return;
        }
        /*function countDistance (A, B) {
            var distance = Math.sqrt(pow2(A.x-B.x)+pow2(A.y-B.y));
            console.log(distance);
            return distance;
        }*/
        function drawTriangle(A, B, C) {
            drawLine(A,B);
            drawLine(B,C);
            drawLine(C,A);
            return;
        }
        function drawLine(A, B) {
            var A = {
                x:Math.round(A.x),
                y:Math.round(A.y)
            };
            var B = {
                x:Math.round(B.x),
                y:Math.round(B.y)
            };
            ctx.beginPath();
            ctx.moveTo(A.x, A.y);
            ctx.lineTo(B.x, B.y);
            ctx.stroke();
            return;
        }
        function drawPoint(pnt) {
            var x = Math.round(pnt.x);
            var y = Math.round(pnt.y);
            var radius = 2;
            ctx.beginPath();
            ctx.moveTo(x+radius, y);
            ctx.arc(x, y, radius, 0, 2*Math.PI, true);
            ctx.fill();
            return;
        }
        //####################################################################################
        return function () {

        }
    }
</script>
</body>
</html>