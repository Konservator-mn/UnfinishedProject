<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>changeColor</title>
</head>
<body>
<script>
    var canvas = document.createElement('canvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    document.body.appendChild(canvas);

    var ctx = canvas.getContext('2d');
    /*
    1. Получить картинку,
    2. Перевести картинку в бинарные данные,
    3. Изменить цвет
    4. Отразить на полотне
     */
    getImage("./logo.png")
        .then(changeSize)
        .then(getImgData)
        //.then(changeColor)
        .then(function (imgData){
            ctx.putImageData(imgData, 0, 0);
        });

    function changeColor(imgData) {
        var color = [116, 232, 33];
        imgData.paintedPixels = [];
        return new Promise(function (colorChanged) {
            for (var i = 0; i<imgData.data.length; i=i+4){
                if (imgData.data[i] || imgData.data[i+1] || imgData.data[i+2] || imgData.data[i+3]){
                    for (var j = 0; j<color.length; ++j) {
                        imgData.data[i + j] = color[j];
                    }
                    imgData.paintedPixels.push(i);
                }

                if (i+4 === imgData.data.length) {
                    colorChanged(imgData);
                    console.log("Color changed:");
                    console.log(imgData);
                }
            }
        });
    }

    function getImgData(img) {
        var testCtx = getTestCtx(img.naturalWidth, img.naturalHeight);
        testCtx.drawImage(img, 0, 0);
        var imgData = testCtx.getImageData(0, 0, img.naturalWidth, img.naturalHeight);
        return new Promise(function (resolve) {
            resolve(imgData);
            console.log("Got Image Data:");
            console.log(new ImageData(imgData));
        });
    }
    function changeSize(img) {
        var sizes = {
            width: 50,
            height: 50
        };
        var mul = Math.max((sizes.width || img.naturalWidth)/img.naturalWidth,(sizes.height || img.naturalHeight)/img.naturalHeight);
        var width = img.naturalWidth*mul;
        var height = img.naturalHeight*mul;
        img.width = width;
        img.height = height;
        img.visible = function() {
            this.style.display = "block";
            console.log(img);
            console.log("display block");
            return this;
        }
        img.invisible = function () {
            this.style.display = "none";
            return new Promise(function (sizeChanged) {
                sizeChanged(img);
            })
        }
        document.body.appendChild(img);
        return img.visible().invisible();
    }
    function getImage(src) {
        var img = new Image();
        window.logo = img;
        img.style.position = "fixed";
        img.style.bottom = "0px";
        img.style.right = "0px";
        img.style.display = "none";
        return new Promise(function (recieved) {
            img.onload = function(){
                recieved(img);
                console.log("Image recieved:");
                console.log(img);
            };
            img.src = src;
        });
    }

    function getTestCtx(width, height) {
        var canvas = document.createElement('canvas');
        canvas.height = height;
        canvas.width = width;
        return canvas.getContext('2d');
    }

</script>
</body>
</html>